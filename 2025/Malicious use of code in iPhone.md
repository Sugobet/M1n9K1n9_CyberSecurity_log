# iPhone场景下的登录验证码隐蔽恶意利用

## 前言

是的，又是与MFA相关的文章，它已经不是第一次出现在我们的公众号里了，包括我的微软赏金在内都与MFA有非常大的关联，我不知道为什么至此之后总是会跟MFA打交道，**可能也是缘分吧**。

这篇水文章是我在学习和补充Apple iOS外围知识时，**发现和产生了一些简单的小想法**。同时也得益于绿盟的工作内容，使我的iOS技能点正在逐渐强化。根据大师计划4.2，我后续会逐渐将Apple相关技能点拉高。

## iPhone密码自动填充

我们来简单介绍一下这个熟悉的陌生功能。

这篇文章离不开最关键的主角之一 - 密码自动填充，它是一项在早期iOS系统上添加的功能，用于在输入密码时，自动填充密码本中的复杂密码。

对于短信验证码（一次性代码），它同样适用，这是我们日常中用的非常多的功能，有了它我们极大地减少了手动输入验证码的情况，并且它似乎也是一个默认开启的功能。

另外密码自动填充有个人尽皆知的效果，在验证码自动填充后，对应的验证码短信会被自动删除，这相当于变向为我们清理痕迹。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d5f87691d30645b6afed17b02e793bad.png)

### 针对密码自动填充的保护

在Apple官方文档中记载了有关验证码的保护机制，通过在短信消息中关联域来限制自动填充。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/5c9151de369f477b99222c15af9b90d1.png)

```bash
# 短信消息格式
Your Example code is 123456.

@example.com #123456
```

经过我的实验后，**域名与IP**都成功工作了，只要短信中限定了域名或IP，那么自动填充就只能在对应的域名或IP中运作。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/9628d70cb1bd4c2e982c96bd9e6b97f1.png)

但有一个现实的问题，那就是压根没什么开发者会使用关联域来限定密码自动填充，**因为他们不但需要考虑iPhone用户，同时还要兼顾安卓用户、多设备用户**；

尽管可以简单的通过user-agent来判断用户类型，但这也会增加开发成本，特别是在今时今日短信验证码功能已经成熟的情况下更是如此。

很遗憾的是以我目前的Apple水准并没有发现它有什么安全漏洞，但这个功能为我提供了其他攻击向量的想法。

## 验证码的横向隐蔽利用

这事实上是比较简单的小把戏，简单记录一下今天晚上我与朋友的实验测试。

从过去hook登录页面，到小火炬哥的超级并发爆破，证明这些想法总会有这么一下用武之地。

### 背景故事

现在我们的攻击目标是窃取受害者的wchat某小程序的关键数据，但这个小程序仅允许wchat中绑定手机号进行登录。

在这里我们不考虑其他的攻击向量，只想要得到对方的wchat短信验证码，用于目标小程序进行身份验证。

### 环境

web服务器：我们需要有一个真实的系统/IP/域名/证书....，它不需要伪造任何系统，也可以是第三方开源web框架。

另外：由于密码自动填充仅在https环境下运行，所以web服务器必须升级为https，否则密码自动填充无法工作。

这个web服务器只需要做到一件事情：让用户看不到表面上的恶意或可疑，其中包括域名等，它需要获得信任，并让受害者正常使用功能。

它与传统钓鱼不一样的地方在于，传统钓鱼需要通过欺骗、障眼法使客户相信这是“官方”网站，但这个“官方”我们并不可控，这种伪造很容易被识穿。

**而我们现在做的则是将“官方”主动权夺回，让受害者相信我们是我们自己的“官方”。**

我通过php简单代码进行演示：

我们将创建一个经典的登录页面，它基于短信验证码进行登录/注册

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/dd2de770ecf3411887974dd8baa1ceb9.png)

为了针对iPhone用户，我们可以简单地从php代码中判断user-agent来拒绝掉非iPhone用户

```php
if (stripos($userAgent, 'iPhone') === false) {
    http_response_code(403); 
```

同时，将受害者输入的手机号和验证码输出到log中方便我们查看，在实际作战当中，我们可以通过hook等方式把手机号和otc单独拿出来，稍后我们将会用到，这一步可以程序自动化。

```php
// 发送验证码时
file_put_contents("test.log", "【暗黑之眼】获取验证码请求 - 手机号: " . $phone . "\n", FILE_APPEND);

// 请求登录时
file_put_contents("test.log","【暗黑之眼】登录请求 - 手机号: " . $phone . ", 验证码: " . $code . "\n", FILE_APPEND);
```

现在回到前端js，我们还需要加强一些细节：

```javascript
// 验证码输入框
codeInput.addEventListener('input', function() {
        // 检查这个特定输入框的长度是否为6
        if (this.value.length === 6) {
        	// 自动触发登录按钮
            loginBtn.click();
        }
    });
```

这段js功能其实并不少见，有时候我们在某些系统输入完验证码就会自动登录，省去点击登录按钮的操作，如今也被我用上了。

**这是为了`防后悔`，当受害者习惯了使用密码自动填充功能，当验证码弹出的那一刻，他并不一定会注意到短信发送来源，而是下意识地点击密码自动填充所显示的验证码**

验证码一旦填充完成，js立马自动触发登录，此时验证码将落入我们之手。

即使受害者会注意到短信发送来源，我们可以通过“系统相关性”来降低可疑程度。

### 验证码利用

那么验证码哪里来呢？

我们就需要再次明确一下我们的攻击目标是什么；在这里，我将需要wchat绑定添加手机号功能，这个功能来自访问小程序时需要wchat授权给小程序用于身份验证的。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/1f28eb2ae6ce4324abdab90cec152580.png)

我们的演示来自于这里。

### 整体攻击路径

我们现在梳理一下整体结构

```bash
wchat添加手机号功能 --- （攻击者）受信服务器 --- 受害者客户端
```

1. 当受信服务器接到验证码发送请求，我们的钩子程序将带着手机号去微信请求对应的验证码
2. 受害者收到验证码后通过密码自动填充/手动填充验证码。触发js自动登录
3. 受信服务器收到验证码，同时拿去微信完成添加手机号流程

这样，我们完成了一次可能并不容易被发现的利用，但可怕的是我们的攻击目标并不止步于此，使用相同的前后端代码模板，我们依然可以很轻松的攻击其他许多第三方系统。

以下是我未提前告知朋友过多信息的测试结果，我们的实验成功（当然也有部分原因出于他对我的信任）

他在受信服务器输入手机号并获取验证码，同时我使用他的手机号在wchat请求验证码；最后我拿着验证码达到目的。

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/6e8e4a02e0204bac938581a00c2ba055.png)

### 受害者视角演示视频

这个演示视频是事后拿百度做的小演示

[公众号视频]

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/60a7f9038d0f4b468ab5e5dfddb50645.png)


## 结尾

我们通过这种方式，很轻松的做到无感、隐蔽的恶意横向利用，甚至是轮换；比如今天绑微信，明天上QQ，后天登其他敏感系统

这本质上还是一个信任危机，即便目标对验证码持有怀疑态度，我们依然可以尝试通过前端弹窗等方式来试图欺骗对方以增加临时信任。

保持学习。