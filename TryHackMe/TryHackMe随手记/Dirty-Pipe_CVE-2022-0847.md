# CVE-2022-0847 学习

linux 内核 任意可读文件覆盖漏洞

## tryhackme:

Linux 内核提供了一个名为 "splice()",这实际上是一个快捷方式，旨在加快将文件内容推送到管道中的过程。这种优化是通过将引用移动到存储文件内容的页面来实现的，而不是移动整个数据。换句话说，, splice() 允许我们将管道指向已加载到内存中的页面，其中包含最初由请求只读访问权限的进程打开的文件部分。看看这是怎么回事？

通过将页面拼接到管道中，然后将我们自己的任意数据写入管道，我们可以覆盖页面的内容！


然而，事情并没有那么简单;我们仍然缺少最后一块拼图。通常，当您在拼接文件后写入管道时，一个新的 pipe_buffer 为避免覆盖拼接数据而创建。那么，我们如何强制内核允许我们覆盖相关页面呢？

这是漏洞的真正症结所在，它都可以追溯到 Linux 内核中的两个提交：

Linux 内核 v4.9 （2016） 中引入了一个错误，该错误允许使用任意标志创建管道。当时可用的旗帜都没有任何危险，所以这不是问题，直到......
Linux 内核 v5.8 （2020） 添加了一个新标志 —PIPE_BUF_FLAG_CAN_MERGE.简单来说，此标志告诉内核可以在不强制重写数据的情况下更新页面。
总而言之：我们有一个标志，允许我们告诉内核可以覆盖页面中的数据，我们有一个错误，允许我们为管道指定任意标志，我们有一个系统调用，无意中允许我们将管道指向以只读方式打开的页面缓冲区。可能出现什么问题？

简而言之，漏洞利用首先打开一个设置了只读标志的目标文件 - 为此，我们必须选择一个我们有权读取的文件。然后，该漏洞利用以特殊方式准备管道，强制添加 PIPE_BUF_FLAG_CAN_MERGE flag. 接下来，它使用 splice() 使管道指向目标文件的所需部分。最后，它将用户指定的任何任意数据写入管道，通过 PIPE_BUF_FLAG_CAN_MERGE flag.



效果

那么，这一切意味着什么呢？

简而言之，这意味着，使用正确的代码，我们可以任意覆盖系统上的任何文件，前提是我们可以打开它进行读取。换句话说：如果我们的用户对文件具有读取访问权限（无论其他权限或可变性如何），那么我们也可以写入它。有趣的是，这也适用于只读文件系统，或者内核通常会阻止我们写入的其他受保护文件;通过利用内核漏洞并绕过“通常”的写入方法，我们还绕过了这些保护。重要的是要注意，在内核选择回收页面使用的内存之前，这些更改实际上不是永久性的（此时页面被转储到磁盘）。在内核回收内存之前重新启动设备或手动清除页面缓存会将文件恢复到其原始内容。

---

该漏洞不允许我们附加到文件中，只是覆盖其已有的内容

使用grep -b查找指定文件内容开头的下标

gcc编译poc.c并运行，覆盖/etc/passwd指定内容

<pre><font color="#47D4B9"><b>tryhackme@dirty-pipe</b></font>:<font color="#277FFF"><b>~/Exploit</b></font>$ gcc -o ./poc ./PoC/poc.c 
<font color="#47D4B9"><b>tryhackme@dirty-pipe</b></font>:<font color="#277FFF"><b>~/Exploit</b></font>$ ./poc /etc/passwd 189 &apos;sugo:$1$hack$eu7wA.3faDMt9Z2srODT9/:0:0:root:/root:/bin/bash
&gt; &apos;
It worked!
</pre>

可以看到passwd已被修改

---

tryhackme:

当您尝试写入 SUID 程序时，它们通常会丢失其 SUID 位;但是，Dirty Pipe 不会发生这种情况——换句话说，我们可以写入任何有权以更高权限执行的程序，而不会无意中破坏该额外权限（通常会发生这种情况）

#### 更进一步的漏洞利用

Bl4sty的漏洞利用了这一点。而不是覆盖像这样的文件 /etc/passwd, 它覆盖用户指定的 SUID 二进制文件（例如 /bin/su), 将shellcode注入其中，然后在特权用户的权限下执行（即. root). 具体来说，该漏洞利用劫持选定的 SUID 二进制文件，并强制其在  /tmp 具有 SUID 位和调用 /bin/sh.然后，它通过重新添加覆盖的部分将目标 SUID 二进制文件恢复到完全工作顺序，并使用新创建的后门程序授予攻击者 shell 作为特权用户.


---

简单来说就是将/bin/sh或指定的文件的数据通过dirty-pipe漏洞覆盖掉指定suid可执行文件,并且不会破坏其权限
