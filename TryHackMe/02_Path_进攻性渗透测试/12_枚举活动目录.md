# Enumerating Active Directory

### AD 枚举

一旦我们有了第一组 AD 凭据以及在网络上对其进行身份验证的方法，一个充满可能性的全新世界就会打开！我们可以通过经过身份验证的访问（甚至是超低特权访问）开始枚举有关 AD 设置和结构的各种详细信息。

在红队参与期间，这通常会导致我们能够执行某种形式的权限提升或横向移动以获得额外的访问权限，直到我们有足够的权限来执行和实现我们的目标。在大多数情况下，枚举和利用严重交织在一起。一旦枚举阶段显示的攻击路径被利用，将再次从这个新的特权位置执行枚举，如下图所示。

<img src='https://tryhackme-images.s3.amazonaws.com/user-uploads/6093e17fa004d20049b6933e/room-content/c23543561279c63190fb0f9bd98f210f.png' />

---

### Credential Injection

您是否曾经找到过 AD 凭据，但没有地方可以使用它们登录？Runas 可能是您一直在寻找的答案！

在安全评估中，你通常具有网络访问权限，并且刚刚发现了 AD 凭据，但没有创建加入域的新计算机的方法或权限。因此，我们需要能够在我们控制的Windows计算机上使用这些凭据。

如果我们有 <用户名>：\<password> 格式的 AD 凭据，则可以使用 Runas（合法的 Windows 二进制文件）将凭据注入内存。通常的 Runas 命令如下所示：

    runas.exe /netonly /user:<domain>\<username> cmd.exe

/netonly - 由于我们未加入域，因此我们希望加载用于网络身份验证的凭据，但不针对域控制器进行身份验证。因此，在计算机上本地执行的命令将在标准 Windows 帐户的上下文中运行，但任何网络连接都将使用此处指定的帐户进行。
/user - 在这里，我们提供域和用户名的详细信息。使用完全限定域名 （FQDN） 而不仅仅是域的 NetBIOS 名称始终是一个安全的选择，因为这将有助于解析。
cmd.exe - 这是我们要在注入凭据后执行的程序。这可以更改为任何内容，但最安全的选择是cmd.exe因为您可以使用它来启动所需的任何内容，并注入凭据。
运行此命令后，系统将提示您提供密码。请注意，由于我们添加了 /netonly 参数，域控制器不会直接验证凭据，因此它将接受任何密码。我们仍然需要确认网络凭据已成功且正确加载。

### IP 与主机名

问题：两者之间有区别吗 dir \\\\za.tryhackme.com\SYSVOL和dir \\\\\<DC IP>\SYSVOL为什么对 DNS 大惊小怪？

有相当大的差异，它归结为所使用的身份验证方法。当我们提供主机名时，网络身份验证将首先尝试执行 Kerberos 身份验证。由于 Kerberos 身份验证使用票证中嵌入的主机名，因此如果我们改为提供 IP，则可以强制身份验证类型为 NTLM。虽然从表面上看，这对我们来说并不重要，但最好了解这些细微的差异，因为它们可以让您在红队评估期间保持更加隐蔽。在某些情况下，组织将监控OverPass-and Pass-the-Hash攻击。强制 NTLM 身份验证是书中避免在这些情况下检测的好技巧。

### 使用注入的凭据

现在我们已经将 AD 凭据注入内存，这就是乐趣开始的地方。使用 /netonly 选项，所有网络通信都将使用这些注入的凭据进行身份验证。这包括从该命令提示符窗口执行的应用程序的所有网络通信。

---

### 微软管理控制台

在此任务中，我们将探索第一个枚举方法，这是在最后一个任务之前使用 GUI 的唯一方法。我们将使用 Microsoft 管理控制台 （MMC） 和远程服务器管理工具 （RSAT） AD 管理单元。如果您使用提供的 Windows VM （THMJMP1），则它已经为您安装。但是，如果您使用的是自己的 Windows 计算机，则可以执行以下步骤来安装管理单元：

    按开始
    搜索“应用和功能”，然后按回车键
    单击“管理可选功能”
    点击添加要素
    搜索“RSAT”
    选择“RSAT：Active Directory 域服务和轻量级目录工具”，然后单击“安装”

您可以通过使用 Windows “开始”按钮、搜索“运行”并键入 MMC 来启动 MMC。如果我们只是正常运行 MMC，它将无法工作，因为我们的计算机未加入域，并且我们的本地帐户不能用于向域进行身份验证。

由于凭据，MMC 启动失败

这就是上一个任务中的 Runas 窗口发挥作用的地方。在该窗口中，我们可以启动 MMC，这将确保所有 MMC 网络连接都将使用我们注入的 AD 凭据。

在 MMC 中，我们现在可以附加 AD RSAT 管理单元：

单击“文件”->“添加/删除管理单元”
选择并添加所有三个活动目录管理单元
单击任何错误和警告
右键单击 Active Directory 域和信任，然后选择更改林
输入 za.tryhackme.com 作为根域，然后单击确定
右键单击 Active Directory 站点和服务，然后选择“更改林”
输入 za.tryhackme.com 作为根域，然后单击确定
右键单击活动目录用户和计算机，然后选择更改域
输入 za.tryhackme.com 作为域，然后单击确定
右键单击左侧窗格中的“活动目录用户和计算机”
单击查看 ->高级功能
如果到目前为止一切正常，则 MMC 现在应指向目标域并针对目标域进行身份验证：

MMC AD 管理单元

现在，我们可以在此处开始枚举有关 AD 结构的信息。

### 好处

    GUI 为全面了解 AD 环境提供了一种极好的方法。
    可以对不同的AD对象进行快速搜索。
    它提供了一种直接方法来查看 AD 对象的特定更新。
    如果我们有足够的权限，我们可以直接更新现有的AD对象或添加新的AD对象。

### 缺点

    GUI 需要对执行它的计算机进行 RDP 访问。
    尽管搜索对象速度很快，但无法执行收集 AD 范围的属性或属性。

---

### 命令提示符

有时您只需要执行快速而肮脏的广告 查找，命令提示符会支持您。当您可能没有对系统的RDP访问权限时，可靠的CMD很方便，防御者正在监视PowerShell的使用，并且您需要执行AD枚举 通过远程访问木马 （RAT）。嵌入一个甚至会有所帮助 网络钓鱼有效负载中的几个简单的 AD 枚举命令 帮助您获得可以帮助您进行决赛的重要信息 攻击。

---

我们可以使用该命令通过子选项列出 AD 域中的所有用户：

    net user /doamin

这将为我们返回所有 AD 用户，并有助于确定域的大小以进行进一步的攻击。我们还可以使用此子选项枚举有关单个用户帐户的更多详细信息：

    net user <userName> /domain

---

我们可以使用该命令通过子选项枚举域的组：

    net group /domain

这些信息可以帮助我们找到目标执行的目标特定群体。我们还可以通过在同一命令中指定组来枚举更多详细信息，例如组的成员身份：

    net group <groupName> /domain

---

我们可以使用该命令通过子选项枚举域的密码策略：

    net accounts /domain

这将为我们提供有用的信息，例如：

    保留的密码历史记录的长度。表示用户必须提供多少个唯一密码才能重复使用旧密码。
    密码尝试不正确的锁定阈值以及帐户将被锁定的时间。
    密码的最小长度。
    允许密码达到的最长期限，指示是否必须定期轮换密码。

如果我们想对我们现在枚举的其他用户帐户进行额外的密码喷射攻击，则此信息可以使我们受益。它可以帮助我们更好地猜测我们应该在攻击中使用哪些密码，以及在我们冒锁定帐户的风险之前我们可以运行多少次攻击。但是，应该注意的是，如果我们执行盲密码喷射攻击，我们无论如何都可能会锁定帐户，因为我们没有检查以确定该特定帐户在被锁定之前还剩下多少次尝试。

### 好处

不需要额外的或外部的工具，这些简单的命令通常不受蓝队的监控。
我们不需要 GUI 来执行此枚举。
VBScript 和其他通常用于网络钓鱼有效负载的宏语言本机支持这些命令，因此它们可用于在创建更具体的有效负载之前枚举有关 AD 域的初始信息。

### 缺点

必须从已加入域的计算机执行这些命令。如果计算机未加入域，它将默认为 WORKGROUP 域.

这些命令可能不会显示所有信息。例如，如果用户是十个以上组的成员，则并非所有这些组都会显示在输出中.

---

### PowerShell

PowerShell是命令提示符的升级版。微软于2006年首次发布。虽然PowerShell具有命令提示符提供的所有标准功能，但它也提供对cmdlet（发音为command-lets）的访问，这些cmdlet是用于执行特定功能的.NET类。虽然我们可以像PowerView的创建者那样编写自己的cmdlet，但使用内置的cmdlet我们已经可以走得很远。

由于我们在任务 3 中安装了 AD-RSAT 工具，因此它会自动为我们安装关联的 cmdlet。已安装 50+ 个 cmdlet。我们将研究其中的一些，但有关 cmdlet 的完整列表，请参阅此列表。

使用我们的SSH终端，我们可以使用以下命令将其升级到PowerShell终端：powershell

### 用户

我们可以使用 cmdlet 枚举 AD 用户：

    Get-ADUser -Identity <userName> -Server <DC> -Properties *

.

    -Identity - 我们正在枚举的帐户名称

    -Properties - 将显示与帐户关联的属性，*将显示所有属性

    -Server - 由于我们没有加入域，因此我们必须使用此参数将其指向我们的域控制器

我们还可以使用允许对枚举进行更多控制的参数，并使用 cmdlet 整齐地显示结果，如下所示：

    Get-ADUser -Filter 'Name -like "*stevens"' -Server za.tryhackme.com | Format-Table Name,SamAccountName -A

---

我们可以使用该 cmdlet 枚举 AD 组：

    Get-ADGroup -Identity <groupName> -Server za.tryhackme.com

我们还可以使用 cmdlet 枚举组成员身份：

    Get-ADGroupMember -Identity <groupName> -Server za.tryhackme.com

---

可以使用 cmdlet 对任何 AD 对象执行更通用的搜索。例如，如果我们要查找在特定日期之后更改的所有 AD 对象：

    Get-ADObject

---

我们可以用来检索有关特定域的其他信息：

    Get-ADDomain -Server za.tryhackme.com

### 好处

PowerShell cmdlet 可以枚举比命令提示符中的网络命令多得多的信息。
我们可以指定服务器和域，以使用未加入域的计算机中的 runas 来执行这些命令。
我们可以创建自己的 cmdlet 来枚举特定信息。
我们可以使用 AD-RSAT cmdlet 直接更改 AD 对象，例如重置密码或将用户添加到特定组。
缺点

PowerShell通常更多地由蓝色团队监控，而不是命令提示符。
我们必须安装 AD-RSAT 工具或使用其他可能检测到的脚本进行 PowerShell 枚举。

---

最后，我们将了解如何使用 [Bloodhound](https://github.com/BloodHoundAD/BloodHound) 执行 AD 枚举。Bloodhound 是迄今为止最强大的 AD 枚举工具，当它在 2016 年发布时，它永远改变了 AD 枚举的格局。

### Bloodhound 历史

在相当长的一段时间里，红队员（不幸的是，攻击者）占了上风。如此之多，以至于微软在其高级威胁防护解决方案中集成了他们自己的Bloodhound版本。这一切都归结为以下短语：

    “防御者在列表中思考，攻击者在图表中思考。”

Bloodhound允许攻击者（现在也是防御者）以图形格式可视化AD环境，其中包含互连的节点。每个连接都是一条可能的路径，可以利用它来实现目标。相比之下，防御者使用列表，例如域管理员列表或环境中所有主机的列表。

这种基于图形的思维为攻击者打开了一个世界。它允许两阶段攻击。在第一阶段，攻击者将执行网络钓鱼攻击以获取枚举AD信息的初始条目。这个初始有效载荷通常非常嘈杂，在攻击者除了泄露枚举数据之外执行任何操作之前，蓝队就会检测到并包含它。但是，攻击者现在可以离线使用此数据以图形格式创建攻击路径，精确显示所需的步骤和跃点。在第二次网络钓鱼活动中使用这些信息，一旦实现漏洞，攻击者通常可以在几分钟内达到目标。这通常比蓝队收到第一个警报还要快。这就是图表思维的力量，这就是为什么如此多的蓝队也开始使用这些类型的工具来更好地了解他们的安全状况。

### SharpHound

您经常会听到用户交替使用Sharphound和Bloodhound。但是，它们并不相同。Sharphound是Bloodhound的枚举工具。它用于枚举 AD 信息，然后可以在寻血猎犬中直观地显示这些信息。寻血猎犬是用于显示AD攻击图的实际GUI。因此，我们首先需要学习如何使用 Sharphound 枚举 AD，然后才能使用 Bloodhound 直观地查看结果。

有三种不同的SharpHound：

    Sharphound.ps1 - 用于运行 Sharphound 的 PowerShell 脚本。但是，最新版本的Sharphound已经停止发布Powershell脚本版本。此版本非常适合与 RAT 一起使用，因为脚本可以直接加载到内存中，从而避免磁盘上的 AV 扫描。

    Sharphound.exe - 用于运行Sharphound的Windows可执行版本。

    AzureHound.ps1 - 用于运行 Sharphound for Azure（Microsoft Cloud Computing Services）实例的 PowerShell 脚本。Bloodhound 可以引入从 Azure 枚举的数据，以查找与 Azure 标识和访问管理配置相关的攻击路径。

---

    C:\Tools\Sharphound.exe --CollectionMethods <Methods> --Domain za.tryhackme.com --ExcludeDCs

参数说明：

    CollectionMethods - 确定 Sharphound 将收集的数据类型。最常见的选项是“Default”或“All”。此外，由于 Sharphound 会缓存信息，因此在第一次运行完成后，您只能使用 Session 收集方法来检索新的用户会话以加快该过程。

    Domain - 在这里，我们指定要枚举的域。在某些情况下，您可能希望枚举与现有域信任的父域或其他域。您可以通过更改此参数来告诉 Sharphound 应该枚举哪个域。

    ExcludeDC - 这将指示 Sharphound 不要接触域控制器，从而降低 Sharphound 运行引发警报的可能性。

---

Bloodhound是一个GUI，它允许我们导入Sharphound捕获的数据并将其可视化到攻击路径中。Bloodhound使用Neo4j作为其后端数据库和绘图系统。Neo4j是一个图形数据库管理系统。如果您使用的是攻击框，则可以使用程序坞中的红色寻血猎犬图标来启动它。在所有其他情况下，请确保在您的攻击计算机上安装和配置了 Bloodhound 和 neo4j。无论哪种方式，了解后台发生的事情都是很好的。在启动 Bloodhound 之前，我们需要加载 Neo4j：

    neo4j console

在另一个终端选项卡中，运行 。这将向您显示身份验证 GUI：

    ./bloodhound --no-sandbox

将sharphound的收集结果zip传到攻击机：

    scp <AD Username>@THMJMP1.za.tryhackme.com:C:/Users/<AD Username>/Documents/<Sharphound ZIP> ./sharp.zip

---

我们可以看到，返回了大量有关我们使用的信息。每个类别都提供以下信息：

    概述 - 提供摘要信息，例如帐户拥有的活动会话数以及是否可以达到高价值目标。
    节点属性 - 显示有关 AD 帐户的信息，例如显示名称和标题。
    额外属性 - 提供更详细的 AD 信息，例如可分辨名称和帐户的创建时间。
    组成员身份 - 显示有关帐户所属的组的信息。
    本地管理员权限 - 提供有关帐户具有管理权限的已加入域的主机的信息。
    执行权限 - 提供有关特殊特权的信息，例如通过 RDP 连接到计算机的能力。
    出站控制权限 - 显示有关此帐户有权修改其属性的 AD 对象的信息。
    入站控制权限 - 提供有关可以修改此帐户属性的 AD 对象的信息。

---

在我们的例子中，寻血猎犬显示了一条攻击路径。它显示其中一个 T1 管理员 ACCOUNT 通过使用其凭据向工作站 THMJMP1 进行身份验证，从而破坏了分层模型。它还显示属于域用户组的任何用户（包括我们的 AD 帐户）都能够通过 RDP 连接到此主机。

我们可以执行以下操作来利用此路径：

    使用我们的 AD 凭据将 RDP 连接到 THMJMP1。
    在主机上查找可为我们提供管理访问权限的权限提升向量。
    使用管理访问权限，我们可以使用凭据收集技术和工具，例如 Mimikatz。
    由于 T1 管理员在 THMJMP1 上具有活动会话，因此我们的凭据收集将为我们提供关联帐户的 NTLM 哈希。
    这是一个简单的例子。在正常情况下，攻击路径可能相对复杂，需要多次操作才能达到最终目标。如果您对与每个边缘相关的漏洞感兴趣，以下寻血猎犬文档提供了很好的指南。Bloodhound 是一个非常强大的 AD 枚举工具，可提供对攻击面的 AD 结构的深入见解。值得努力使用它并学习它的各种功能。

### 仅会话数据

AD的结构不会改变 通常在大型组织中。可能有几个新员工， 但 OU、组、用户和权限的整体结构将 保持不变。
但是，不断更改的一件事是活动会话和登录事件。由于 Sharphound 创建了 AD 结构的时间点快照，因此活动会话数据并不总是准确的，因为某些用户可能已经注销了他们的会话，或者新用户可能已经建立了新会话。这是一件需要注意的重要事情，这就是为什么我们要定期执行Sharphound的原因。

一个好的方法是在评估开始时使用“全部”收集方法执行 Sharphound，然后使用“会话”收集方法每天至少执行两次 Sharphound 。这将为您提供新的会话数据，并确保这些运行速度更快，因为它们不会再次枚举整个 AD 结构。执行这些会话运行的最佳时间是在 10：00 左右，当用户喝第一杯咖啡并开始工作时，在 14：00 左右，当他们从午休时间回来但在回家之前。

您可以在从这些新的 Sharphound 运行导入数据之前，在数据库信息选项卡上清除 Bloodhound 中停滞的会话数据，方法是单击“清除会话信息”。

### 好处

提供用于 AD 枚举的 GUI。

能够显示枚举的 AD 信息的攻击路径。
提供对通常需要多次手动查询才能恢复的 AD 对象的更深入见解。

### 缺点

需要执行 Sharphound，这是嘈杂的，通常可以通过 AV 或 EDR 解决方案检测到。

---

枚举 AD 是一项艰巨的任务。需要正确的 AD 枚举才能更好地了解域的结构并确定可用于执行权限提升或横向移动的攻击路径。

### 其他枚举技术

在这个网络中，我们介绍了几种可用于枚举AD的技术。这绝不是一份详尽的清单。下面是值得一提的枚举技术列表：

LDAP 枚举 - 任何有效的 AD 凭据对都应能够绑定到域控制器的 LDAP 接口。这将允许您编写 LDAP 搜索查询来枚举有关域中 AD 对象的信息。

PowerView - PowerView 是 PowerSploit 项目的侦察脚本部分。尽管此项目不再获得支持，但 PowerView 等脚本对于在紧要关头执行 AD 对象的半手动枚举非常有用。

Windows Management Instrumentation （WMI） - WMI 可用于枚举来自 Windows 主机的信息。它有一个名为“root\directory\ldap”的提供程序，可用于与 AD 交互。我们可以在PowerShell中使用此提供程序和WMI来执行AD枚举。

---

我们还应该注意到，这个房间的重点是列举整个AD域的结构，而不是只关注识别错误配置和弱点。侧重于识别弱点（如不安全的共享或分层模型中的中断）的枚举将在以后的会议室中讨论。

### 缓解措施

AD 枚举非常难以防御。其中许多技术模仿常规网络流量和行为，因此很难区分恶意流量和正常流量。但是，我们可以采取一些措施来检测潜在的恶意行为：

强大的 AD 枚举技术（如 Sharphound）在枚举会话信息时会生成大量登录事件。由于它是从单个 AD 帐户执行的，因此这些登录事件将与此单个帐户相关联。我们可以编写检测规则来检测此类行为（如果它发生在用户帐户中）。
我们可以为必须为特定 AD 枚举技术安装的工具编写签名检测规则，例如 SharpHound 二进制文件和 AD-RSAT 工具。
除非我们组织的员工使用，否则我们可以监控组织中命令提示符和Powershell的使用，以检测来自未经授权来源的潜在枚举尝试。
附带说明一下，蓝队本身也可以定期使用这些枚举技术来识别AD域结构中的差距和错误配置。如果我们能够解决这些错误配置，即使攻击者枚举了我们的 AD，他们也无法找到可用于权限提升或横向移动的错误配置。

现在我们已经枚举了 AD，下一步是跨域执行权限提升和横向移动，以进入合适的位置来发起攻击。这将在隔壁的房间进行介绍。
